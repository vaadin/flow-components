Subject: [PATCH] Debug GWT using SDM
---
Index: vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow/src/main/resources/META-INF/resources/frontend/vaadin-spreadsheet/vaadin-spreadsheet.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow/src/main/resources/META-INF/resources/frontend/vaadin-spreadsheet/vaadin-spreadsheet.js b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow/src/main/resources/META-INF/resources/frontend/vaadin-spreadsheet/vaadin-spreadsheet.js
--- a/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow/src/main/resources/META-INF/resources/frontend/vaadin-spreadsheet/vaadin-spreadsheet.js	(revision 51001c89efeaa53ee79f01a93c78cbd29b9defe8)
+++ b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow/src/main/resources/META-INF/resources/frontend/vaadin-spreadsheet/vaadin-spreadsheet.js	(date 1682011876843)
@@ -6,6 +6,7 @@
 import { LitElement, html } from 'lit';
 import { Spreadsheet } from './spreadsheet-export.js';
 import { spreadsheetStyles, spreadsheetOverlayStyles } from './vaadin-spreadsheet-styles.js';
+let ExportedSpreadsheet = Spreadsheet;
 
 const spreadsheetResizeObserver = new ResizeObserver((entries) => {
   entries.forEach((entry) => entry.target.api.resize());
@@ -170,7 +171,7 @@
         document.body.appendChild(overlays);
       }
 
-      this.api = new Spreadsheet(this.renderRoot);
+      this.api = new ExportedSpreadsheet(this.renderRoot);
       this.api.setHeight('100%');
       this.api.setWidth('100%');
       this.createCallbacks();
@@ -542,4 +543,38 @@
   }
 }
 
-window.customElements.define('vaadin-spreadsheet', VaadinSpreadsheet);
+const defineElement = () => window.customElements.define('vaadin-spreadsheet', VaadinSpreadsheet);
+
+// A workaround for using the GWT SuperDevMode server when running at localhost
+// - First we check that the application is running in localhost
+// - Second we try to contact SDM with a timeout of 200ms
+// - Finally we load the exported spreadsheet from the SDM instead of from local
+if (/localhost|127.0.0.1/.test(location.hostname)) { // Check that app is running in localhost
+  window.Vaadin = window.Vaadin ||Â {};
+  const sdmUrl = `http://${location.hostname}:9876/SpreadsheetApi/SpreadsheetApi.nocache.js`;
+  const controller = new AbortController();
+  setTimeout(() => controller.abort(), 200); // Try to contact SDM in 200ms
+  fetch(sdmUrl, {signal: controller.signal} )
+    .then(response => {
+      if (response.status != 200) {
+        throw(new Error());
+      }
+      delete window.Vaadin.Spreadsheet; // spreadsheet is exported to window.Vaadin.Spreadsheet
+      const s = document.createElement('script');
+      s.src = sdmUrl;
+      document.head.prepend(s);
+      const id = setInterval(() => {
+        if (window.Vaadin.Spreadsheet) { // wait until spreadsheet is exported
+          clearInterval(id);
+          ExportedSpreadsheet = Vaadin.Spreadsheet.Api;
+          defineElement() // use spreadsheet from SDM
+          console.warn(`Spreadsheet is using GWT SDM at ${sdmUrl}`);
+          console.warn(`For recompiling GWT install the bookmark from http://${location.hostname}:9876/`);
+        }
+      }, 200);
+    }).catch(() => {
+      defineElement() // use spreadsheet from local
+    });
+} else {
+  defineElement() // use spreadsheet from local
+}
Index: vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApiXSI.gwt.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApiXSI.gwt.xml b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApiXSI.gwt.xml
new file mode 100644
--- /dev/null	(date 1682011876817)
+++ b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApiXSI.gwt.xml	(date 1682011876817)
@@ -0,0 +1,43 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<module rename-to='SpreadsheetApi'>
+  <!-- Inherit the core Web Toolkit stuff.                        -->
+  <inherits name='com.google.gwt.user.User' />
+
+  <!-- Inherit the default GWT style sheet.  You can change       -->
+  <!-- the theme of your GWT application by uncommenting          -->
+  <!-- any one of the following lines.                            -->
+<!--   <inherits name='com.google.gwt.user.theme.standard.Standard' /> -->
+  <!-- <inherits name='com.google.gwt.user.theme.chrome.Chrome'/> -->
+  <!-- <inherits name='com.google.gwt.user.theme.dark.Dark'/>     -->
+
+  <!-- Other module inherits                                      -->
+
+  <!-- Inherit DefaultWidgetSet -->
+  <inherits name="com.vaadin.DefaultWidgetSet" />
+
+  <inherits name="com.vaadin.addon.spreadsheet.Widgetset" />
+<!--   <stylesheet src="addons/spreadsheet/spreadsheet.css"/> -->
+
+
+  <!-- Specify the app entry point class.                         -->
+  <entry-point class='com.vaadin.component.spreadsheet.client.js.SpreadsheetEntryPoint' />
+
+  <!-- Specify the paths for translatable code                    -->
+  <source path='js' />
+
+  <!-- Generator for connectors -->
+  <generate-with
+          class="com.vaadin.component.spreadsheet.client.SpreadsheetConnectorBundleLoaderFactory">
+    <when-type-assignable
+            class="com.vaadin.client.metadata.ConnectorBundleLoader" />
+  </generate-with>
+
+  <!--
+    The value gecko1_8 is used for Firefox 3 and later and safari is used
+    for webkit based browsers including Google Chrome.
+  -->
+  <set-property name="user.agent" value="gecko1_8,safari"/>
+  <set-configuration-property name="devModeRedirectEnabled" value="true" />
+
+  <add-linker name="xsiframe" />
+</module>
Index: vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/pom.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/pom.xml b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/pom.xml
--- a/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/pom.xml	(revision 51001c89efeaa53ee79f01a93c78cbd29b9defe8)
+++ b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/pom.xml	(date 1682011876808)
@@ -98,6 +98,24 @@
     </dependency>
   </dependencies>
 
+  <profiles>
+    <profile>
+      <id>sdm</id>
+      <properties>
+        <gwt.module>com.vaadin.component.spreadsheet.client.SpreadsheetApiXSI</gwt.module>
+      </properties>
+      <build>
+        <defaultGoal>gwt:run-codeserver</defaultGoal>
+      </build>
+      <dependencies>
+        <dependency>
+          <groupId>org.slf4j</groupId>
+          <artifactId>slf4j-simple</artifactId>
+        </dependency>
+      </dependencies>
+    </profile>
+  </profiles>
+
   <build>
     <!-- Output classes directly into the webapp, so that IDEs and "mvn process-classes" update them in DevMode -->
     <outputDirectory>${project.build.directory}/${project.build.finalName}/WEB-INF/classes</outputDirectory>
Index: vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApi.gwt.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApi.gwt.xml b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApi.gwt.xml
--- a/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApi.gwt.xml	(revision 51001c89efeaa53ee79f01a93c78cbd29b9defe8)
+++ b/vaadin-spreadsheet-flow-parent/vaadin-spreadsheet-flow-client/src/main/resources/com/vaadin/component/spreadsheet/client/SpreadsheetApi.gwt.xml	(date 1682011876817)
@@ -1,47 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <module rename-to='SpreadsheetApi'>
-  <!-- Inherit the core Web Toolkit stuff.                        -->
-  <inherits name='com.google.gwt.user.User' />
-
-  <!-- Inherit the default GWT style sheet.  You can change       -->
-  <!-- the theme of your GWT application by uncommenting          -->
-  <!-- any one of the following lines.                            -->
-<!--   <inherits name='com.google.gwt.user.theme.standard.Standard' /> -->
-  <!-- <inherits name='com.google.gwt.user.theme.chrome.Chrome'/> -->
-  <!-- <inherits name='com.google.gwt.user.theme.dark.Dark'/>     -->
 
-  <!-- Other module inherits                                      -->
-
-  <!-- Inherit DefaultWidgetSet -->
-  <inherits name="com.vaadin.DefaultWidgetSet" />
-
-  <inherits name="com.vaadin.addon.spreadsheet.Widgetset" />
-<!--   <stylesheet src="addons/spreadsheet/spreadsheet.css"/> -->
-
-
-  <!-- Specify the app entry point class.                         -->
-  <entry-point class='com.vaadin.component.spreadsheet.client.js.SpreadsheetEntryPoint' />
-
-  <!-- Specify the paths for translatable code                    -->
-  <source path='js' />
-
-  <!-- Generator for connectors -->
-  <generate-with
-          class="com.vaadin.component.spreadsheet.client.SpreadsheetConnectorBundleLoaderFactory">
-    <when-type-assignable
-            class="com.vaadin.client.metadata.ConnectorBundleLoader" />
-  </generate-with>
-
-
+  <!-- Inherits the SpreadsheetApi module -->
+  <inherits name='com.vaadin.component.spreadsheet.client.SpreadsheetApiXSI' />
   <!-- Use custom single script linker without document.write, doens't work with SDM and GWT unit tests -->
   <define-linker name="humlinker" class="com.vaadin.component.spreadsheet.client.SpreadsheetLinker" />
   <add-linker name="humlinker" />
-
-  <!--
-    The value gecko1_8 is used for Firefox 3 and later and safari is used
-    for webkit based browsers including Google Chrome.
-  -->
-  <set-property name="user.agent" value="gecko1_8,safari"/>
-  <set-configuration-property name="devModeRedirectEnabled" value="true" />
-
 </module>
